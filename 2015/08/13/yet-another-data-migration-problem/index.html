<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Yet another data migration problem &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/static/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="144x144" href="/public/apple-touch-icon.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home" class='logo'></a>
          <nav class="pull toggle-content">
            <ul class="top-nav">
              
              <li><h2><a href="/archive">Archive</a></h2></li>
              
              <li><h2><a href="/atom.xml">Feed</a></h2></li>
              
            </ul>
          </nav>
          <div class="text-right navicon">
            <a id="nav-toggle" class="nav_slide_button" href="#"><span></span></a>
          </div>
        </h3>
      </header>

      <main>
        
<p>
<i class="glyphicon glyphicon-tags" style="padding-right: .5rem;"></i>

<a href="/tag/PostgreSQL" title="View posts tagged with &quot;PostgreSQL&quot;"><u>PostgreSQL</u></a>, 

<a href="/tag/data migration" title="View posts tagged with &quot;data migration&quot;"><u>data migration</u></a>

</p>


<article class="post">
  <h1 class="post-title">Yet another data migration problem</h1>
  <time datetime="2015-08-13T11:19:28+00:00" class="post-date">13 Aug 2015</time>
  
  <p></p>
  
  <p><strong>TL;DR</strong> <em>Ensure data consistency while copying data across databases having RDBMS (PostgreSQL in this case) on board.</em></p>

<h3 id="the-problem">The problem</h3>

<p>Imagine you have two databases, such a they’ve had the same parent in the past. As the time goes by, some of the data might change in any of them. Now, you’d like to copy object A between databases under assumption that it’s only going to create a copy if there’s no equal object in the destination database. The object might contain foreign keys and such associations are also considered during checking equality.</p>

<h3 id="considerations">Considerations</h3>

<p>The easiest solution you’d think of is dump the data you want and then restore in destination database. Such approach, however, implies that you’d need a tool taking only data you want to copy. Not the whole database or table, only object A with its associations. PostgreSQL provides <a href="http://www.postgresql.org/docs/current/static/backup-dump.html">pg_dump</a> or <a href="http://www.postgresql.org/docs/current/interactive/sql-copy.html">copy</a> for data migrations, however none of them lets you deal with associations easily. You’d then use some higher level tools, e.g. any ORM you like and deal with <em>deep</em> object copy itself.</p>

<p>To check for equality, you’d need some data to compare. The best candidate would be to compare record <code class="language-plaintext highlighter-rouge">id</code> and its foreign keys. In this case however, you’re guaranteed that <code class="language-plaintext highlighter-rouge">id</code> in database X and Y points to the same record. They may differ and result in a mess.</p>

<h5 id="check-for-hashdatabase_xa--hashdatabase_ya">Check for hash(database_X(A)) == hash(database_Y(A))</h5>

<p>Another approach would be to calculate a hash of the data you’d like to compare and then use hashes instead of ids. So if the result matches, you’d not need to make a copy and for further operations, you’d just use record id.</p>

<h4 id="build-a-hash-of-record">Build a hash of record</h4>

<p>To build a hash, you’d add a trigger to your database with appropriate function, e.g:</p>

<figure class="highlight"><pre><code class="language-plpgsql" data-lang="plpgsql">CREATE OR REPLACE FUNCTION update_post_footprint_func()
RETURNS trigger AS $$
DECLARE raw_footprint text;
BEGIN

raw_footprint := concat(NEW.title, NEW.content, NEW.owner_id);
NEW.footprint := (SELECT md5(raw_footprint));

RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_post_footprint BEFORE INSERT OR UPDATE ON posts FOR EACH ROW EXECUTE PROCEDURE update_post_footprint_func();</code></pre></figure>

<p>Such function will build new hash for given record for each insert or update. As you’d notice, this use case considers only 1 x 1 relationship at most and doesn’t cover 1 x N. For instance, a post record might have many tags. In this case you have two choices, either select for footprints of the dependencies (note that it implies any dependency has its own footprint), e.g:</p>

<figure class="highlight"><pre><code class="language-plpgsql" data-lang="plpgsql">raw_footprint := concat(...,
(select array_to_string(array(select footprint from tags where post_id = NEW.id order by id ASC), '|')));</code></pre></figure>

<p>or build parent footprint based on the dependency data, e.g:</p>

<figure class="highlight"><pre><code class="language-plpgsql" data-lang="plpgsql">raw_footprint := concat(...,
(select array_to_string(array(select name from tags inner join post_tags on tags.id = post_tags.tag_id where post_tags.post_id = NEW.id order by id ASC), '|')));</code></pre></figure>

<p>The footprint build process is somewhat similar to the <a href="http://edgeguides.rubyonrails.org/caching_with_rails.html#russian-doll-caching">Russian Doll</a> caching pattern, despite you need to be aware that dependencies footprint must be built before the record footprint. However, it only applies when refering dependency footprints directly.</p>

<h3 id="possible-issues">Possible issues</h3>

<ol>
  <li>Depending on the record dependencies, there might be a need to build a few/several triggers, where each generates sub-footprint, finally assembled with the main footprint.</li>
  <li>The speed. Since each trigger execution is a non-zero time consuming operation, the need of using it should be further discussed and associated with the use case. If it’s going to be rarely used and data insertions/updates are heavy, perhaps it would be a better idea to use it within the app itself.</li>
</ol>


</article>

<aside class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2016/11/07/interface-designer-manifesto/">
          Software Interface Designer Manifesto
          <small><time datetime="2016-11-07T21:38:32+00:00">07 Nov 2016</time></small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2016/01/27/meet-stats-whisper-the-stats-gatherer/">
          Stats Whisper, the stats gatherer
          <small><time datetime="2016-01-27T19:50:40+00:00">27 Jan 2016</time></small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2016/01/14/devops-in-small-companies-part-ii-entering-automation/">
          DevOps in small companies – part II – entering automation
          <small><time datetime="2016-01-14T16:24:53+00:00">14 Jan 2016</time></small>
        </a>
      </h3>
    </li>
    
  </ul>
</aside>



<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'opensoftwareblog';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



      </main>

      <footer class="footer">
        <small>
          OpenSoftware <time datetime="2022-07-07T21:28:21+00:00">2022</time>. CC BY-NC-SA 3.0.
        </small>
      </footer>
    </div>
    <script>
      var show = function (elem) {
        elem.classList.add('is-visible');
      };

      // Hide an element
      var hide = function (elem) {
        elem.classList.remove('is-visible');
      };

      // Toggle element visibility
      var toggle = function (elem) {
        elem.classList.toggle('is-visible');
      };

      document.querySelector("#nav-toggle").addEventListener("click", function(event) {
        var content = document.querySelector(".pull");
        if (!content) return;

        toggle(content);
      });

    </script>
  </body>
</html>
